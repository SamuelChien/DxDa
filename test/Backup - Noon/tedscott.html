<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>User Profile</title>
	<link rel="shortcut icon" href="/static/favicon.ico">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css">	
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.css">	
	<link rel="stylesheet" type="text/css" href="//getbootstrap.com/examples/dashboard/dashboard.css">	
	
	<script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.12.4.js"></script>
	<script type="text/javascript" language="javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
	<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.js"></script>
	<style>
	.navbar-brand {
    position: absolute;
    left: 50%;
    margin-left: -50px !important;
	text-align: center;
	display:block;
    margin: auto;
	}
	
	.link {
	  fill: none;
	  stroke: #666;
	  stroke-width: 1.5px;
	}

	.link.excel {
	  stroke: green;
	}

	.link.word {
		stroke: blue;
	}

	.link.powerpoint {
		stroke: red;
	}

	circle {
	  fill: #ccc;
	  stroke: #333;
	  stroke-width: 1.5px;
	}

	text {
	  font: 14px sans-serif;
	  pointer-events: none;
	  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
	}
	</style>
  </head>
  <body>
   <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
		  <a href="https://microsoft.sharepoint.com/teams/ODI/" title="Office Data Science">
		    <img src="http://hs-spades-01/static/images/ods-logo.png" style="height:50px" class="img-responsive" alt="user">
		  </a>
         </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Settings</a></li>
            <li><a href="/about">About</a></li>
          </ul>
          <form class="navbar-form navbar-right" action="/static/table.html" method="GET">
            <input type="text" name="alias" class="form-control" placeholder="Search alias...">
          </form>
		  <a class="navbar-brand" href="#">April 2017 Hackathon</a>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
		  <li></li>
		  <center><img src="https://docs.moodle.org/27/en/images_en/7/7c/F1.png" class="img-responsive" alt="user" id="profilePic"></center><br>
          <ul class="nav nav-sidebar">
            <li class="active"><a href="#overview">Overview <span class="sr-only">(current)</span></a></li>
            <li><a href="#expertise">Expertise Level</a></li>
            <li><a href="#chart">Expertise chart</a></li>
            <li><a href="#network">My Network</a></li>
			<li><a href="#usagemapanchor">My Usage</a></li>
            <li><a href="#">More Stuff</a></li>
          </ul>
		  
        </div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
  	      <h2 id="overview">Overview</h2>
		  <div id="overviewDiv"></div>
		  <img src="" class="img-responsive" id="appAward">
		  <br>

  	      <h2 id="expertise">Expertise Level</h2>
		  <div class="table-responsive">
            <table id="Table1" class="display" cellspacing="0" width="100%">
              <thead>
                <tr>
				  <th>Alias</th>
				  <th>UserId</th>
				  <th><img src="http://hs-spades-01/static/images/word-vector-small.png" class="img-responsive" alt="Word"></th>
				  <th><img src="http://hs-spades-01/static/images/excel-vector-small.png" class="img-responsive" alt="Excel"></th>
				  <th><img src="http://hs-spades-01/static/images/powerpoint-vector-small.png" class="img-responsive" alt="PowerPoint"></th>
				</tr>
              </thead>
              <tbody>
              </tbody>
			</table>
		  </div>

		  <hr/>
  	      <h2 id="chart">Influencer Score</h2>
		  <div id="chart1">
			<svg></svg>
		  </div>
		  			<hr/>
  	      <h2 id="My Network">My Network</h2>
		  <h4>Shown are your top 25 collaborators from January 1 - April 7, 2017</h4>
		  <h4>Edges are colored by the most prevalent application used: <i style="color:blue">Word</i>, <i style="color:green">Excel</i>, <i style="color:red">PowerPoint</i></h4>
		  <i>click and drag a node to perturb the network</i>
		  <table>
		  <tr>
		  <td>
		  <div id="graphword">
			<svg id="svgword" ></svg>
		  </div>
		  </td>
		  </table>
		  
			<hr/>
  	      <h2 id="usagemapanchor">Office App Usage</h2>
		  <div class="col-sm-9 col-sm-offset-1 col-md-10 col-md-offset-2 main">
			Most used App is <div id="App" style="display: inline"></div><br/>
			&nbsp;&nbsp;-> used for <div id="Weeks" style="display: inline"></div> days in the past 12 weeks<br/>
			<h2>Badges</h2>
			<style>
			#dogfood {
			display: none;
			height: 100px;
			width: 100px;
			}			
			#multiplat {
			display: none;
			height: 100px;
			width: 120px;
			}
			</style>
			<img id="dogfood" src="dogfood.jpg"/>
			<img id="multiplat" src="multiplatform.png"/>
			<hr/>     
        </div>
		    <select id="appname" style="dropdownmenu" onchange="refreshusagemap()">
			<option value="">Select Another App</option>
          <option value="Word">Word</option>
          <option value="Excel">Excel</option>
          <option value="PowerPoint">PowerPoint</option>
          <option value="Office">Office</option>
          <option value="Publisher">Publisher</option>
          <option value="Outlook">Outlook</option>
          <option value="OneNote">OneNote</option>
          <option value="Access">Access</option>
    </select>
    <br/>

      <iframe id="usagemap" src="http://hs-spades-01:419/usagemap.php" onload="this.width=700;this.height=210;" frameBorder="0"></iframe>
      <iframe id="logging" src="" onload="this.width=700;this.height=50;" frameBorder="0">xyz</iframe>
      <iframe id="speedometer" src="http://hs-spades-01/static/gauge.html?alias=sanjeb" onload="this.width=700;this.height=210;" frameBorder="0"></iframe>

        </div>
  	  </div>
	</div>
	
	<script type="text/javascript" language="javascript">
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
 
$(document).ready(function() {
	var alias = getParameterByName('alias');
	if (alias.length<1) {
	  $.ajax({
	  type:"GET",
	  url:"/user",
	  success: function(data) {
	  console.log("data:" + data);
	  alias = data;
	  },
	  async: false
	  })
	}
  	console.log("alias:" + alias);
	
	if (alias.length<1) alias="jhoegger";
	document.getElementById('logging').src = "http://hs-spades-01:419/log2.php?alias=" + alias+"&page_url="+encodeURIComponent(window.location.href);

	var img2=document.getElementById('appAward');
	$('#overview').html("Overview for " + alias);
	url = "http://hs-spades-01/table/UserProficiencyScores/Alias/" + alias;
	$.getJSON(url, function(data) {
		d = data[0];
		s = "Congratulations, " + d.Alias 
		if (d.Word > 7){
		s += "! You are level " + d.Word + " in Word";
		img2.src='http://hs-spades-01/static/images/word-award1.png';
		}
		else if (d.Excel > 7){
		s += "! You are level " + d.Excel + " in Excel";
		img2.src='http://hs-spades-01/static/images/excel-award1.png';
		}
		else if (d.PowerPoint > 7){
		s += "! You are level " + d.PowerPoint + " in PowerPoint";
		img2.src='http://hs-spades-01/static/images/powerpoint-award1.png';
		}
		else {
		s += "! You are level " + d.PowerPoint + " in PowerPoint";
		img2.src='';
		}
			
		$('#overviewDiv').html(s)
	})
	
	var url1ma = "".concat("http://hs-spades-01/table/PuidLevelFeatures/Alias/", alias, "/");
	var url2ma = "".concat("http://hs-spades-01/table/SELECT%20TOP%201%20*%20FROM%20TotalAppUsage%20WHERE%20Alias='", alias, "'%20ORDER%20BY%20DaysUsed%20DESC%20FOR%20JSON%20PATH;");

	//alert(url);
	$.getJSON( url1ma, function( data ) {
	  $("#Alias").html(data[0].Alias)			
	  $("#UserId").html(data[0].Puid)
	  //$("#App").html(data[0].MaxUseApp)
	  //$("#Weeks").html(data[0].WeeksUsed)
	  var DogfoodImage = document.getElementById("dogfood");
	  if ((data[0].AnyDogfood) == 1) {
		DogfoodImage.style.display = 'inline-block';
	  }
	  var MultiplatImage = document.getElementById("multiplat");
	  if ((data[0].NumOS) > 1) {
		MultiplatImage.style.display = 'inline-block';
	  }
	});

	//alert(url);
	$.getJSON( url2ma, function( data ) {
	  $("#App").html(data[0].AppName)
	  $("#Weeks").html(data[0].DaysUsed)
	  MostUsedApp = data[0].AppName;
	  document.getElementById('usagemap').src = "http://hs-spades-01:419/usagemap.php?alias="+alias+"&appname="+MostUsedApp;
	});	
	document.getElementById('usagemap').src = "http://hs-spades-01:419/usagemap.php?alias="+alias+"&appname=Office";
	document.getElementById('speedometer').src = "http://hs-spades-01/static/gauge.html?alias="+alias;
	
	var img1=document.getElementById('profilePic');
	img1.src='http://who/Photos/' + alias + '.jpg';
	
	$('#Table1').DataTable( {
			ajax: {
				url: "http://hs-spades-01/table/UserProficiencyScores/Alias/" + alias + "/?type=datatables",
				type: 'GET'
			},
		    columns: [
				{ data: "Alias" },
				{ data: "UserId" },
				{ data: "Word" },
				{ data: "Excel" },
				{ data: "PowerPoint" }
			]
		})
		
				// Generate Network Graphs		
		//http://hs-spades-01/table/SELECT%20*%20FROM%20CollabByAlias_20170420125803%20WHERE%20source='TEDSCOTT'%20OR%20target='TEDSCOTT'%20FOR%20JSON%20PATH;
		// get the json object of source-target pairs
		 
		 var rawWord = (function() {
				var json = null;
				//var alias = getParameterByName("alias");
				if (alias==null) 
				{
				alias="tedscott"
				}
				upper_alias = alias.toUpperCase();
				
				$.ajax({
					'async': false,
					'global': false,
					'url':"http://hs-spades-01/table/SELECT TOP 50 * FROM CollabByAlias_20170420125803 WHERE (source='" + upper_alias + "' OR target='" + upper_alias +"') ORDER BY weight DESC FOR JSON PATH;",
					//'url':"http://hs-spades-01/table/SELECT TOP 25 * FROM CollabByAlias_20170420125803 WHERE type='word' AND (source='" + upper_alias + "' OR target='" + upper_alias +"') FOR JSON PATH;",
			  'type': 'GET',
					'dataType': "text",
					'success': function (data) {
						json = data;
					}
				});
				return json;
			})(); 

		// parse it	
		objWord = JSON.parse(rawWord);	

		var nodesWord = {};
		var linksWord = [];

		// build dictionary
		for (i=0; i<objWord.length; i++) {
			var current=objWord[i];
			linksWord.push({
				source:(current.source),
				target:(current.target),
				type:(current.type),
				weight:(current.weight)
			  })
		}

		// it should be in this format
		/* var links = 
		[
			{"source": "Rui", "target": "Ted", "type": "suit"},
			{"source": "Mihai", "target": "Rui", "type": "suit"},
			{"source": "Ted", "target": "Mihai", "type": "suit"},
			{"source": "John", "target": "Rui", "type": "suit"},
			{"source": "John", "target": "Ted", "type": "suit"}
		]; */


		// Compute the distinct nodes from the links.
		linksWord.forEach(function(link) {
		  link.source = nodesWord[link.source] || (nodesWord[link.source] = {name: link.source});
		  link.target = nodesWord[link.target] || (nodesWord[link.target] = {name: link.target});
		});


			
		//links

		var width = 500,
			height = 500;

		var forceWord = d3.layout.force()
			.nodes(d3.values(nodesWord))
			.links(linksWord)
			.size([width, height])
			.linkDistance(180)
			.charge(-500)
			.on("tick", tick)
			.start();

		//var graphid = "#graph"+app+" #svg"+app;	
			
		var svgWord = d3.select("#graphword #svgword")//.append("svg")
			.attr("width", width)
			.attr("height", height);

		// Per-type markers, as they don't inherit styles.
		svgWord.append("defs").selectAll("marker")
			.data(["word", "excel", "powerpoint"])
		  .enter().append("marker")
			.attr("id", function(d) { return d; })
			.attr("viewBox", "0 -5 10 10")
			.attr("refX", 15)
			.attr("refY", -1.5)
			.attr("markerWidth", 6)
			.attr("markerHeight", 6)
			.attr("orient", "auto")
		  .append("path")
			.attr("d", "M0,-5L10,0L0,5");

		var path = svgWord.append("g").selectAll("path")
			.data(forceWord.links())
		  .enter().append("path")
			.attr("class", function(d) { var linkstyle = "link " + d.type; if(d.weight > 4) {linkstyle="link " + d.type + "heavy"}; return linkstyle; })
			.attr("marker-end", function(d) { return "url(#" + d.type + ")"; });

		var circle = svgWord.append("g").selectAll("circle")
			.data(forceWord.nodes())
		  .enter().append("circle")
			.attr("r", function(d) {var rad=3; if(d.name==upper_alias) {rad=6} return rad})
			//.attr("r", 6)
			.call(forceWord.drag);

		var text = svgWord.append("g").selectAll("text")
			.data(forceWord.nodes())
		  .enter().append("text")
			.attr("x", 8)
			.attr("y", 3)
			.attr("dy","0.35em")
			.text(function(d) { return d.name; });

			
		// Use elliptical arc path segments to doubly-encode directionality.
		function tick() {
		  path.attr("d", linkArc);
		  circle.attr("transform", transform);
		  text.attr("transform", transform);
		}

		function linkArc(d) {
			var i = Math.random(), per=0;
			
			if(i < 0.5) {
				per = Math.floor(Math.random() * -1 * 40);
			}
			else { 
				per = Math.floor(Math.random() * 40);
			}
		  var dx = d.target.x - d.source.x,
			  dy = d.target.y - d.source.y,
			  dr = Math.sqrt(dx * dx + dy * dy) + per;
		  return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
		}

		function transform(d) {
		  return "translate(" + d.x + "," + d.y + ")";
		}
		
		
		
		
		});
	function refreshusagemap(){
    var alias = getParameterByName('alias');
    document.getElementById('usagemap').src = "http://hs-spades-01:419/usagemap.php?alias="+alias+"&appname="+document.getElementById("appname").value;
  }

</script>

	</script>
<script>

var url = "http://hs-spades-01/table/UserInfluenceScores/Puid/10033FFF8006C468/?type=nvd3"
d3.json(url, 
function(data) {
  nv.addGraph(function() {
    var chart = nv.models.discreteBarChart()
            .x(function(d) { return d.AppName })
            .y(function(d) { return d.ScoreRank })
			.margin({top: 30, right: 20, bottom: 50, left: 100})
			.showValues(true);

    chart.xAxis
        .axisLabel("My App")

    chart.yAxis
        .axisLabel("Score rank (#)")
        .tickFormat(d3.format(',.0f'));

    d3.select('#chart1 svg')
		.attr("height", 400)
        .datum(data)
		.transition()
		.duration(500)
        .call(chart);

    nv.utils.windowResize(chart.update);

    return chart;
  });
});
</script>
</body>
</html>	